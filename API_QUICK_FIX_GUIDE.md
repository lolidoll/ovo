# API 响应提取问题 - 快速解决方案

## 问题症状
- 显示错误："❌ 主API调用失败：未在返回中找到文本回复"
- API 端点本身是可用的（能返回数据）
- 但无法从返回的数据中提取文本

## 快速诊断 (3 步)

### 步骤 1: 打开控制台看诊断信息
1. 按 **F12** 打开开发者工具
2. 点击 **Console** 标签
3. 触发 API 调用（发送消息）
4. 查找以下红色错误信息：
   ```
   ═════════════════════════════════════════════════
   ❌ 无法从主API响应中提取文本 - 完整诊断信息
   ═════════════════════════════════════════════════
   ```

### 步骤 2: 记录 API 响应结构
在诊断信息中找到：
```
📊 响应顶级结构:
  - keys: [这里显示API返回的字段名]
```

**示例**：
- 如果显示 `['choices', 'model', 'usage']` → 这是 OpenAI 格式（应该能自动处理）
- 如果显示 `['data', 'status', 'message']` → 这是自定义格式，需要配置

### 步骤 3: 在完整响应数据中查找文本
在诊断信息的最后找到：
```
📄 完整响应数据 (前2000字符):
```

查看 JSON 结构，找出包含实际回复文本的字段的完整路径。

**常见例子**：
- `data.answer` - 如果文本在 data 对象的 answer 字段
- `result.message` - 如果文本在 result 对象的 message 字段
- `response.text` - 如果文本在 response 对象的 text 字段

## 自动处理的格式

以下格式会自动识别，不需要额外配置：

✅ OpenAI / 兼容格式
```json
{"choices": [{"message": {"content": "文本"}}]}
```

✅ Google Gemini 格式
```json
{"candidates": [{"content": {"parts": [{"text": "文本"}]}}]}
```

✅ 一级字段格式
```json
{"output": "文本"} / {"result": "文本"} / {"text": "文本"} ...
```

## 需要配置自定义字段映射时

### 情况：API 返回非标准格式

**步骤**：

1. **确定正确的字段路径**（从诊断信息）
   - 例如：`data.result.text`

2. **配置到 API 设置**
   - 打开 API 设置界面
   - 找到"自定义响应字段路径"选项
   - 输入字段路径：`data.result.text`

3. **如果有多个可能的路径**
   - 每行输入一个
   - 示例：
     ```
     data.result.text
     response.answer
     output.message
     ```

4. **保存设置后重新测试**

## 字段路径格式

### 基本语法
- `fieldName` - 顶级字段
- `parent.child` - 嵌套字段
- `parent.0.child` - 数组项字段（0 表示第一项）

### 实例

| 路径 | 适用情况 |
|------|---------|
| `data.message` | `{"data": {"message": "文本"}}` |
| `choices.0.message.content` | OpenAI 格式（自动支持） |
| `candidates.0.content.parts.0.text` | Gemini 格式（自动支持） |
| `result.0.output` | 数组中第一项的 output 字段 |
| `response.text` | `{"response": {"text": "文本"}}` |

## 测试是否生效

配置自定义路径后：

1. 打开控制台 (F12)
2. 清空之前的日志
3. 发送消息触发 API 调用
4. 在控制台中查找：
   - ✅ 如果看到 `✅ 使用自定义字段映射成功提取: data.result.text`
     → 配置成功！
   - ❌ 如果仍看到错误提示
     → 路径可能不对，重新检查

## 常见错误

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 配置后仍然出错 | 字段名大小写不匹配 | 检查 JSON 中的确切大小写 |
| 无法找到文本 | 路径太深或字段名错误 | 查看完整 JSON 重新确认路径 |
| 错误消息没变化 | 配置未保存 | 确保点击了"保存"按钮 |
| 路径格式不清楚 | 不确定数组索引 | 数组用 0, 1, 2 表示索引位置 |

## 我的 API 完全不同怎么办？

如果以上都不行，可能是：

1. **API 返回的是文本而不是 JSON**
   - 检查响应类型（Content-Type 头）
   - 可能需要在 API 端配置为返回 JSON

2. **API 返回错误而不是成功响应**
   - 检查 HTTP 状态码是否为 200
   - 查看错误信息（应该在诊断日志中显示）

3. **响应被截断或损坏**
   - 检查网络是否正常
   - 尝试增加 max_tokens 或超时时间

## 需要帮助？

查看详细文档：[API_RESPONSE_EXTRACTION_FIX.md](API_RESPONSE_EXTRACTION_FIX.md)

其中包含：
- 完整的技术细节
- 所有改进的列表
- 更多诊断建议
- 支持的所有格式列表
