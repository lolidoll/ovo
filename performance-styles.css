/**
 * 性能优化样式表 - 移动端增强版
 * 包含针对聊天界面的CSS性能优化
 * 
 * @module PerformanceStyles
 * @version 2.0.0
 */

/* ========== 全局移动端优化 ========== */

* {
    /* 移除点击高亮延迟 */
    -webkit-tap-highlight-color: transparent;
    /* 禁用文本选择（除输入框外） */
    -webkit-user-select: none;
    user-select: none;
    /* 禁用默认触摸行为 */
    -webkit-touch-callout: none;
}

/* 输入框允许文本选择 */
input, textarea, select, [contenteditable="true"] {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
    touch-callout: default !important;
}

/* ========== 可点击元素优化 ========== */

.clickable-optimized,
button,
.btn,
[role="button"],
.tab-item,
.msg-item,
.friend-item,
.menu-item,
.func-item {
    /* 优化触摸响应 */
    touch-action: manipulation;
    /* GPU加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    /* 减少合成层 */
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    /* 告知浏览器属性变化 */
    will-change: transform;
    /* 禁用文本选择 */
    -webkit-user-select: none;
    user-select: none;
    cursor: pointer;
}

/* 点击反馈动画 */
.clickable-optimized:active,
button:active,
.btn:active,
.tab-item:active {
    opacity: 0.7;
    transform: translateZ(0) scale(0.98);
    transition: transform 0.05s ease, opacity 0.05s ease;
}

/* ========== 滚动容器优化 ========== */

.chat-messages,
.msg-list,
.friend-list,
.menu-list,
.moments-list,
.shopping-list {
    /* 启用GPU加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    
    /* 告诉浏览器这个元素的哪些属性会变化 */
    will-change: scroll-position;
    
    /* 限制重排和重绘的范围 */
    contain: layout style paint;
    
    /* 优化滚动性能 */
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    
    /* 减少合成层创建 */
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    perspective: 1000px;
    
    /* 防止过度滚动 */
    overscroll-behavior-y: contain;
}

/* ========== 消息气泡优化 ========== */

.chat-bubble {
    /* 减少重排 */
    contain: layout style;
    
    /* 只在需要时通知浏览器属性变化 */
    will-change: transform;
    
    /* 硬件加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    
    /* 减少合成层 */
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

.chat-bubble.selected {
    /* 选中状态只改变背景色 */
    will-change: background-color;
}

/* ========== 头像优化 ========== */

.chat-avatar,
.msg-avatar,
.friend-avatar {
    contain: layout style;
    will-change: transform;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* ========== 加载更多提示优化 ========== */

.load-more-hint {
    contain: layout style;
    will-change: transform, opacity;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

/* ========== 消息内容优化 ========== */

.message-content,
.message-text {
    contain: layout style;
    will-change: auto;
}

/* ========== 图片优化 ========== */

.message-image,
.chat-avatar img,
.msg-avatar img,
.friend-avatar img {
    contain: layout;
    will-change: opacity;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    /* 防止图片闪烁 */
    image-rendering: -webkit-optimize-contrast;
}

/* ========== 动画和过渡优化 ========== */

/* 使用GPU加速的淡入动画 */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateZ(0) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateZ(0) translateY(0);
    }
}

.chat-bubble.new-message {
    animation: fadeIn 0.2s ease-out;
    will-change: transform, opacity;
}

/* 消息高亮动画 */
@keyframes highlightPulse {
    0%, 100% {
        background-color: rgba(0, 123, 255, 0.1);
    }
    50% {
        background-color: rgba(0, 123, 255, 0.2);
    }
}

.chat-bubble.highlight-message {
    animation: highlightPulse 1.5s ease-in-out;
    contain: layout style;
}

/* ========== 页面切换优化 ========== */

.main-content {
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    contain: layout style paint;
}

.main-content.active {
    display: flex;
    animation: fadeIn 0.15s ease-out;
}

/* ========== 底部标签栏优化 ========== */

.tab-bar {
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    contain: layout style;
    /* position 不在此覆盖，保持 style.css 中的 fixed */
    isolation: isolate;
}

.tab-item {
    touch-action: manipulation;
    will-change: opacity, transform;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    position: relative;
    isolation: isolate;
    transition: opacity 0.1s ease, transform 0.1s ease;
}

.tab-item:active {
    opacity: 0.6;
    transform: translateZ(0) scale(0.95);
}

.tab-item.active {
    opacity: 1;
}

/* ========== 侧边栏优化 ========== */
/* 注意：不覆盖原始的 slide 动画效果，只添加性能优化 */

.side-menu {
    will-change: transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    contain: layout style;
}

/* 遮罩层优化 */
.mask {
    transform: translateZ(0);
    will-change: opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    contain: layout style paint;
}

/* ========== 子页面优化 ========== */

.sub-page,
.add-popup {
    transform: translateZ(0);
    will-change: transform, opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    contain: layout style paint;
}

/* ========== 列表渲染优化 ========== */

/* 使用CSS Containment优化大量消息渲染 */
.chat-messages > *,
.msg-list > *,
.friend-list > * {
    contain: layout style;
}

/* 减少重排的伪元素 */
.chat-bubble::before,
.chat-bubble::after,
.msg-item::before,
.msg-item::after,
.friend-item::before,
.friend-item::after {
    contain: layout;
}

/* ========== 语音消息优化 ========== */

.voice-bubble {
    contain: layout style;
    will-change: transform;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

/* ========== 翻译内容优化 ========== */

.translation-content {
    contain: layout style;
    will-change: opacity;
}

/* ========== 表情包优化 ========== */

.emoji-sticker {
    contain: layout;
    will-change: transform;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

/* ========== 位置消息优化 ========== */

.location-message {
    contain: layout style;
    will-change: transform;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

/* ========== 撤回消息优化 ========== */

.retracted-message-wrapper {
    contain: layout style;
    will-change: opacity;
}

/* ========== 引用消息优化 ========== */

.reply-reference {
    contain: layout style;
    will-change: auto;
}

/* ========== 多选模式优化 ========== */

.chat-bubble.selected {
    contain: layout style;
    will-change: background-color, transform;
}

/* ========== 消息时间戳优化 ========== */

.message-time,
.msg-time {
    contain: layout;
    will-change: opacity;
}

/* ========== 防止过度滚动 ========== */

body, html, #app-container {
    overscroll-behavior: none;
    overscroll-behavior-x: none;
    overscroll-behavior-y: none;
}

/* ========== 工具类 ========== */

/* 强制GPU加速 */
.gpu-accelerated {
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* 限制重排重绘 */
.contain-layout {
    contain: layout;
}

.contain-style {
    contain: style;
}

.contain-paint {
    contain: paint;
}

.contain-all {
    contain: layout style paint;
}

/* 优化滚动性能 */
.optimize-scroll {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    will-change: scroll-position;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

/* ========== 移动端特定优化 ========== */

@media (max-width: 768px) {
    /* 移动端减少阴影效果 */
    .msg-item,
    .friend-item,
    .chat-bubble {
        box-shadow: none;
    }
    
    /* 简化动画 */
    .chat-bubble.new-message {
        animation: none;
    }
    
    /* 减少模糊效果 */
    .mask {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }
}

/* ========== iOS Safari 特定优化 ========== */

@supports (-webkit-touch-callout: none) {
    /* iOS Safari 滚动优化 */
    .chat-messages,
    .msg-list,
    .friend-list {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
    }
    
    /* iOS Safari 按钮优化 */
    button,
    .btn,
    .tab-item {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
    }
}

/* ========== Android Chrome 特定优化 ========== */

@supports (not (-webkit-touch-callout: none)) and (pointer: coarse) {
    /* Android Chrome 滚动优化 */
    .chat-messages,
    .msg-list,
    .friend-list {
        overscroll-behavior: contain;
        overflow-scrolling: touch;
    }
}

/* ========== 打印样式优化 ========== */

@media print {
    .chat-messages {
        contain: none;
        transform: none;
    }
    
    .clickable-optimized {
        transform: none;
    }
}